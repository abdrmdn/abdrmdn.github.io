<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Copy and flatten nested s3 files structure</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Copy and flatten nested s3 files structure</h1>
</header>
<section data-field="subtitle" class="p-summary">
This will be a very straightforward blog:
</section>
<section data-field="body" class="e-content">
<section name="1d0d" class="section section--body section--first"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="e5c5" id="e5c5" class="graf graf--h3 graf--leading graf--title">Copy and flatten nested s3 files structure</h3><p name="77f4" id="77f4" class="graf graf--p graf-after--h3">This will be a very straightforward blog:</p><p name="420f" id="420f" class="graf graf--p graf-after--p">I’ve been looking for something that can flatten a huge number of files structured in a very nested way.</p><p name="4f70" id="4f70" class="graf graf--p graf-after--p">Eventually i found that its easier just to write a small script to do that, the script goes as below (the script is in python language):</p><pre name="a4f6" id="a4f6" class="graf graf--pre graf-after--p"># -*- coding: utf-8 -*-<br>&quot;&quot;&quot;<br>This script will copy files from src file in ur bucket to dst in a specified bucket<br>&quot;&quot;&quot;</pre><pre name="03a0" id="03a0" class="graf graf--pre graf-after--pre">from boto.s3.connection import S3Connection<br>import os<br># to fix issue with get_bucket<br># <a href="https://github.com/boto/boto/issues/2836" data-href="https://github.com/boto/boto/issues/2836" class="markup--anchor markup--pre-anchor" rel="nofollow noopener" target="_blank">https://github.com/boto/boto/issues/2836</a><br>import ssl<br>if hasattr(ssl, &#39;_create_unverified_context&#39;):<br>   ssl._create_default_https_context = ssl._create_unverified_context<br>###<br>   <br>AWS_KEY = &#39;your aws key here&#39;<br>AWS_SECRET = &#39;your aws secret here&#39;<br>   <br>conn = S3Connection(AWS_KEY,AWS_SECRET)<br>bucket = conn.get_bucket(&#39;bucket.name.origin_ex_eu-west&#39;);</pre><pre name="81e8" id="81e8" class="graf graf--pre graf-after--pre">for key in bucket.list(prefix=&#39;sourceFolder/&#39;):<br>    print key.name<br>    path, folder = os.path.split(key.name)<br>    if folder != &quot;&quot;:<br>        key.copy(key.bucket, &#39;destinationFolder/&#39;+folder)</pre><blockquote name="d1e2" id="d1e2" class="graf graf--blockquote graf-after--pre"><strong class="markup--strong markup--blockquote-strong">prerequisite :</strong> python 2.7, python editor, s3 access</blockquote><p name="0ffa" id="0ffa" class="graf graf--p graf-after--blockquote">The output/input :</p><p name="5fc2" id="5fc2" class="graf graf--p graf-after--p">Source folder will be for example:</p><ul class="postList"><li name="27ef" id="27ef" class="graf graf--li graf-after--p">Bucket/sourceFile/0.pdf</li><li name="6cf9" id="6cf9" class="graf graf--li graf-after--li">Bucket/sourceFile/1.pdf</li><li name="c47f" id="c47f" class="graf graf--li graf-after--li">Bucket/sourceFile/2/2.pdf</li><li name="c4cc" id="c4cc" class="graf graf--li graf-after--li">Bucket/sourceFile/3/3ier/3.pdf</li></ul><p name="3607" id="3607" class="graf graf--p graf-after--li">Then the destination will be after running the script:</p><ul class="postList"><li name="19c2" id="19c2" class="graf graf--li graf-after--p">Bucket/sourceFile/0.pdf</li><li name="3058" id="3058" class="graf graf--li graf-after--li">Bucket/sourceFile/1.pdf</li><li name="7cd9" id="7cd9" class="graf graf--li graf-after--li">Bucket/sourceFile/2.pdf</li><li name="d7b1" id="d7b1" class="graf graf--li graf-after--li">Bucket/sourceFile/3.pdf</li></ul><p name="df1d" id="df1d" class="graf graf--p graf-after--li graf--trailing">As you can see, the script is pretty straightforward, but the result is quite useful.</p></div></div></section><section name="82fc" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><p name="736a" id="736a" class="graf graf--p graf--leading">And one might argue that this is doable using aws s3 command , but no unfortunately (as per my knowledge), cause ‘aws s3’ only copies.. unless you pipe commands on top of each others like the alternative below:</p><p name="8b58" id="8b58" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Alternative</strong> (proposed by <a href="https://medium.com/u/929784125cd" data-href="https://medium.com/u/929784125cd" data-anchor-type="2" data-user-id="929784125cd" data-action-value="929784125cd" data-action="show-user-card" data-action-type="hover" class="markup--user markup--p-user" target="_blank">Long Nguyễn</a> )</p><p name="f3b3" id="f3b3" class="graf graf--p graf-after--p">Using couple of tools piped on each other’s:</p><blockquote name="0a47" id="0a47" class="graf graf--blockquote graf-after--p graf--trailing">aws s3 ls source-bucket-name — recursive | grep -E “\w+\.+” | awk -F” “ ‘{for(i=4; i&lt;=NF; i++){printf “s3://%s”, $i}; printf “\n”}’ | xargs -I$ aws s3 cp $ s3://destination-bucket-name/</blockquote></div></div></section><section name="bf9b" class="section section--body section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><p name="e764" id="e764" class="graf graf--p graf--leading graf--trailing">Follow me for more useful tips and reads.</p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@abidul.rmdn" class="p-author h-card">Abidul Ramadan</a> on <a href="https://medium.com/p/e2e2ca520569"><time class="dt-published" datetime="2018-08-02T12:05:28.263Z">August 2, 2018</time></a>.</p><p><a href="https://medium.com/@abidul.rmdn/copy-and-flatten-nested-s3-files-structure-e2e2ca520569" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on July 28, 2019.</p></footer></article></body></html>